# syntax=docker/dockerfile:1

# Stage 1: Frontend Development with optimized caching
FROM --platform=$BUILDPLATFORM node:25-trixie-slim AS frontend-dev

RUN npm install -g --force corepack && corepack enable pnpm

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

WORKDIR /app

# Copy lockfile first for better layer caching
COPY pnpm-lock.yaml ./

# Fetch dependencies with cache mount
RUN --mount=type=cache,target=/pnpm/store \
    pnpm fetch --frozen-lockfile

# Copy package files and install
COPY package.json pnpm-workspace.yaml ./
COPY frontend/package.json ./frontend/package.json

RUN --mount=type=cache,target=/pnpm/store \
    pnpm install --frozen-lockfile --offline

ENV NODE_ENV=development \
    PORT=3000

EXPOSE 3000

CMD ["pnpm", "-C", "frontend", "dev", "--host", "0.0.0.0"]

# Stage 2: Backend Development with optimized caching
FROM --platform=$BUILDPLATFORM golang:1.25-trixie AS backend-dev

# Install development tools in a single layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    git \
    tzdata && \
    rm -rf /var/lib/apt/lists/* && \
    go install github.com/air-verse/air@latest

ENV GIN_MODE=debug \
    PORT=3552 \
    ENVIRONMENT=development \
    GOCACHE=/root/.cache/go-build \
    GOMODCACHE=/go/pkg/mod

WORKDIR /app

# Copy Go module files first for dependency caching
COPY backend/go.mod backend/go.sum ./

# Download dependencies with cache mounts
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    go mod download && go mod verify

# Create directories with proper permissions
RUN mkdir -p /app/data /app/.bin && \
    chmod 755 /app/data /app/.bin

EXPOSE 3552

CMD ["air", "-c", ".air.toml"]
