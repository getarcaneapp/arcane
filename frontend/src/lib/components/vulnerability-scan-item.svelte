<script lang="ts">
	import * as ArcaneTooltip from '$lib/components/arcane-tooltip';
	import { Spinner } from '$lib/components/ui/spinner/index.js';
	import { toast } from 'svelte-sonner';
	import type { VulnerabilityScanSummary, SeveritySummary } from '$lib/types/vulnerability.type';
	import { m } from '$lib/paraglide/messages';
	import { vulnerabilityService } from '$lib/services/vulnerability-service';
	import { AlertTriangleIcon, ShieldCheckIcon, ShieldAlertIcon, ScanIcon, ShieldXIcon } from '$lib/icons';

	interface Props {
		scanSummary?: VulnerabilityScanSummary;
		imageId: string;
		onScanned?: (data: VulnerabilityScanSummary) => void;
	}

	let { scanSummary = $bindable(), imageId, onScanned }: Props = $props();

	let isScanning = $state(false);
	let isOpen = $state(false);

	const hasError = $derived(scanSummary?.status === 'failed' || !!scanSummary?.error);
	const isCompleted = $derived(scanSummary?.status === 'completed');
	const hasCritical = $derived((scanSummary?.summary?.critical ?? 0) > 0);
	const hasHigh = $derived((scanSummary?.summary?.high ?? 0) > 0);
	const hasMedium = $derived((scanSummary?.summary?.medium ?? 0) > 0);
	const hasAnyVuln = $derived((scanSummary?.summary?.total ?? 0) > 0);

	const severityColor = $derived.by(() => {
		if (!scanSummary || hasError) return 'gray';
		if (!isCompleted) return 'blue';
		if (hasCritical) return 'red';
		if (hasHigh) return 'orange';
		if (hasMedium) return 'amber';
		if (hasAnyVuln) return 'yellow';
		return 'green';
	});

	async function startScan() {
		if (isScanning) return;

		isScanning = true;
		try {
			const result = await vulnerabilityService.scanImage(imageId);
			if (result) {
				const summary: VulnerabilityScanSummary = {
					imageId: result.imageId,
					scanTime: result.scanTime,
					status: result.status,
					summary: result.summary,
					error: result.error
				};
				scanSummary = summary;
				onScanned?.(summary);

				if (result.error || result.status === 'failed') {
					toast.error(result.error || m.vuln_scan_failed());
				} else {
					toast.success(m.vuln_scan_completed());
				}
			}
		} catch (error) {
			console.error('Error scanning image:', error);
			toast.error(m.vuln_scan_failed());
		} finally {
			isScanning = false;
		}
	}

	function formatSummary(summary: SeveritySummary): string {
		const parts: string[] = [];
		if (summary.critical > 0) parts.push(m.vuln_count_critical({ count: summary.critical }));
		if (summary.high > 0) parts.push(m.vuln_count_high({ count: summary.high }));
		if (summary.medium > 0) parts.push(m.vuln_count_medium({ count: summary.medium }));
		if (summary.low > 0) parts.push(m.vuln_count_low({ count: summary.low }));
		return parts.length > 0 ? parts.join(', ') : m.vuln_no_vulnerabilities();
	}
</script>

{#snippet severityBadge(count: number, label: string, colorClass: string)}
	{#if count > 0}
		<div class="flex items-center justify-between text-xs">
			<span class={colorClass}>{label}</span>
			<span class="font-mono font-medium {colorClass}">{count}</span>
		</div>
	{/if}
{/snippet}

{#snippet tooltipContent()}
	<div class="max-w-[240px] space-y-3 p-3">
		{#if hasError}
			<div class="flex items-center gap-2 text-red-500">
				<ShieldXIcon class="size-4" />
				<span class="text-sm font-medium">{m.vuln_scan_failed()}</span>
			</div>
			{#if scanSummary?.error}
				<p class="text-xs text-muted-foreground">{scanSummary.error}</p>
			{/if}
		{:else if isCompleted && scanSummary?.summary}
			<div class="flex items-center gap-2">
				{#if hasAnyVuln}
					<ShieldAlertIcon class="size-4 text-{severityColor}-500" />
				{:else}
					<ShieldCheckIcon class="size-4 text-green-500" />
				{/if}
				<span class="text-sm font-medium">{m.vuln_summary()}</span>
			</div>
			<div class="space-y-1.5">
				{@render severityBadge(scanSummary.summary.critical, m.vuln_severity_critical(), 'text-red-500')}
				{@render severityBadge(scanSummary.summary.high, m.vuln_severity_high(), 'text-orange-500')}
				{@render severityBadge(scanSummary.summary.medium, m.vuln_severity_medium(), 'text-amber-500')}
				{@render severityBadge(scanSummary.summary.low, m.vuln_severity_low(), 'text-yellow-600')}
				{@render severityBadge(scanSummary.summary.unknown, m.vuln_severity_unknown(), 'text-gray-500')}
			</div>
			{#if !hasAnyVuln}
				<p class="text-xs text-green-600 dark:text-green-400">{m.vuln_no_vulnerabilities()}</p>
			{/if}
		{:else if scanSummary?.status === 'scanning' || isScanning}
			<div class="flex items-center gap-2 text-blue-500">
				<Spinner class="size-4" />
				<span class="text-sm font-medium">{m.vuln_scanning()}</span>
			</div>
		{:else}
			<div class="flex items-center gap-2 text-muted-foreground">
				<ScanIcon class="size-4" />
				<span class="text-sm font-medium">{m.vuln_no_scan()}</span>
			</div>
			<p class="text-xs text-muted-foreground">
				{m.vuln_scanner_not_installed()}
			</p>
		{/if}

		{#if !isScanning && scanSummary?.status !== 'scanning'}
			<button
				onclick={startScan}
				disabled={isScanning}
				class="w-full rounded-md bg-secondary px-3 py-1.5 text-xs font-medium text-secondary-foreground transition-colors hover:bg-secondary/80 disabled:opacity-50"
			>
				{isScanning ? m.vuln_scanning() : m.vuln_scan()}
			</button>
		{/if}
	</div>
{/snippet}

<ArcaneTooltip.Root bind:open={isOpen} interactive>
	<ArcaneTooltip.Trigger>
		<span class="inline-flex items-center justify-center">
			{#if isScanning || scanSummary?.status === 'scanning'}
				<Spinner class="size-4 text-blue-400" />
			{:else if hasError}
				<ShieldXIcon class="size-4 text-red-500" />
			{:else if isCompleted}
				{#if hasCritical}
					<ShieldAlertIcon class="size-4 text-red-500" />
				{:else if hasHigh}
					<ShieldAlertIcon class="size-4 text-orange-500" />
				{:else if hasMedium}
					<ShieldAlertIcon class="size-4 text-amber-500" />
				{:else if hasAnyVuln}
					<ShieldAlertIcon class="size-4 text-yellow-500" />
				{:else}
					<ShieldCheckIcon class="size-4 text-green-500" />
				{/if}
			{:else}
				<button
					onclick={startScan}
					disabled={isScanning}
					class="group flex size-4 items-center justify-center rounded-full border-2 border-dashed border-gray-400 transition-colors hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-950 disabled:cursor-not-allowed"
				>
					<div class="size-1.5 rounded-full bg-gray-400 transition-colors group-hover:bg-blue-400"></div>
				</button>
			{/if}
		</span>
	</ArcaneTooltip.Trigger>
	<ArcaneTooltip.Content side="right">
		{@render tooltipContent()}
	</ArcaneTooltip.Content>
</ArcaneTooltip.Root>
