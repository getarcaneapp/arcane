import BaseAPIService from './api-service';
import { environmentStore } from '$lib/stores/environment.store.svelte';
import type {
	VulnerabilityScanResult,
	VulnerabilityScanSummary,
	ScannerStatus,
	Vulnerability
} from '$lib/types/vulnerability.type';
import type { Paginated, SearchPaginationSortRequest } from '$lib/types/pagination.type';
import { transformPaginationParams } from '$lib/utils/params.util';

export class VulnerabilityService extends BaseAPIService {
	/**
	 * Scan an image for vulnerabilities
	 */
	async scanImage(imageId: string): Promise<VulnerabilityScanResult> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(
			this.api.post(`/environments/${envId}/images/${imageId}/vulnerabilities/scan`)
		);
	}

	/**
	 * Get the full vulnerability scan result for an image
	 */
	async getScanResult(imageId: string): Promise<VulnerabilityScanResult> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.get(`/environments/${envId}/images/${imageId}/vulnerabilities`));
	}

	/**
	 * Get a paginated list of vulnerabilities for an image
	 */
	async getImageVulnerabilities(
		imageId: string,
		options?: SearchPaginationSortRequest
	): Promise<Paginated<Vulnerability>> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		const params = transformPaginationParams(options);
		const res = await this.api.get(`/environments/${envId}/images/${imageId}/vulnerabilities/list`, { params });
		return res.data;
	}

	/**
	 * Get just the vulnerability summary for an image (for list views)
	 */
	async getScanSummary(imageId: string): Promise<VulnerabilityScanSummary> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.get(`/environments/${envId}/images/${imageId}/vulnerabilities/summary`));
	}

	/**
	 * Get the scanner status (whether Trivy is available)
	 */
	async getScannerStatus(): Promise<ScannerStatus> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.get(`/environments/${envId}/vulnerabilities/scanner-status`));
	}
}

export const vulnerabilityService = new VulnerabilityService();
