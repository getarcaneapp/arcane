import BaseAPIService from './api-service';
import { environmentStore } from '$lib/stores/environment.store.svelte';
import type { VulnerabilityScanResult, VulnerabilityScanSummary, ScannerStatus } from '$lib/types/vulnerability.type';

export class VulnerabilityService extends BaseAPIService {
	/**
	 * Scan an image for vulnerabilities
	 */
	async scanImage(imageId: string): Promise<VulnerabilityScanResult> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(
			this.api.post(`/environments/${envId}/images/${imageId}/vulnerabilities/scan`)
		);
	}

	/**
	 * Get the full vulnerability scan result for an image
	 */
	async getScanResult(imageId: string): Promise<VulnerabilityScanResult> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.get(`/environments/${envId}/images/${imageId}/vulnerabilities`));
	}

	/**
	 * Get just the vulnerability summary for an image (for list views)
	 */
	async getScanSummary(imageId: string): Promise<VulnerabilityScanSummary> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.get(`/environments/${envId}/images/${imageId}/vulnerabilities/summary`));
	}

	/**
	 * Get the scanner status (whether Trivy is available)
	 */
	async getScannerStatus(): Promise<ScannerStatus> {
		const envId = await environmentStore.getCurrentEnvironmentId();
		return this.handleResponse(this.api.get(`/environments/${envId}/vulnerabilities/scanner-status`));
	}
}

export const vulnerabilityService = new VulnerabilityService();
